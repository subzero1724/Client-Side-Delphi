unit FormDosenAdmin;

interface

uses
  Winapi.Windows, Winapi.Messages,
  System.SysUtils, System.Variants, System.Classes,
  System.JSON,
  System.UITypes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs,
  Vcl.StdCtrls, Vcl.Grids,
  DosenModel;

type
  TFrmDosenAdmin = class(TForm)
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    edtNIDN: TEdit;
    edtNama: TEdit;
    edtPassword: TEdit;
    sgDosen: TStringGrid;
    btnTambah: TButton;
    btnUpdate: TButton;
    btnDelete: TButton;
    btnClear: TButton;
    btnExit: TButton;
    btnRefresh: TButton;
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnTambahClick(Sender: TObject);
    procedure btnUpdateClick(Sender: TObject);
    procedure btnDeleteClick(Sender: TObject);
    procedure btnClearClick(Sender: TObject);
    procedure btnExitClick(Sender: TObject);
    procedure btnRefreshClick(Sender: TObject);
    procedure sgDosenSelectCell(Sender: TObject; ACol, ARow: Integer;
      var CanSelect: Boolean);
  private
    FSelectedNIDN: string;
    procedure SetupGrid;
    procedure LoadDosen;
    procedure ClearForm;
  end;

var
  FrmDosenAdmin: TFrmDosenAdmin;

implementation

{$R *.dfm}

{ ================= GRID ================= }

procedure TFrmDosenAdmin.SetupGrid;
begin
  sgDosen.ColCount := 2;
  sgDosen.FixedRows := 1;
  sgDosen.FixedCols := 0;
  sgDosen.RowCount := 1;

  sgDosen.Cells[0,0] := 'NIDN';
  sgDosen.Cells[1,0] := 'Nama Dosen';

  sgDosen.ColWidths[0] := 150;
  sgDosen.ColWidths[1] := 300;
end;

{ ================= LOAD DATA ================= }

procedure TFrmDosenAdmin.LoadDosen;
var
  Arr: TJSONArray;
  Obj: TJSONObject;
  I: Integer;
begin
  SetupGrid; // ✅ HEADER SELALU DIPASTIKAN ADA

  Arr := TDosenModel.GetAll;
  if Arr = nil then Exit;

  try
    sgDosen.RowCount := Arr.Count + 1;

    for I := 0 to Arr.Count - 1 do
    begin
      Obj := Arr.Items[I] as TJSONObject;

      sgDosen.Cells[0, I+1] := Obj.GetValue<string>('nidn');
      sgDosen.Cells[1, I+1] := Obj.GetValue<string>('nama');
    end;
  finally
    Arr.Free;
  end;
end;

{ ================= FORM ================= }

procedure TFrmDosenAdmin.FormCreate(Sender: TObject);
begin
  SetupGrid;
end;

procedure TFrmDosenAdmin.FormShow(Sender: TObject);
begin
  LoadDosen;
  ClearForm;
end;

procedure TFrmDosenAdmin.ClearForm;
begin
  edtNIDN.Clear;
  edtNama.Clear;
  edtPassword.Clear;
  edtNIDN.Enabled := True;
end;

{ ================= CRUD ================= }

procedure TFrmDosenAdmin.btnTambahClick(Sender: TObject);
begin
  if (edtNIDN.Text = '') or (edtNama.Text = '') then
  begin
    ShowMessage('NIDN dan Nama wajib diisi');
    Exit;
  end;

  if TDosenModel.Insert(
       edtNIDN.Text,
       edtNama.Text,
       edtPassword.Text
     ) then
  begin
    ShowMessage('Dosen berhasil ditambahkan');
    LoadDosen;
    ClearForm;
  end;
end;

procedure TFrmDosenAdmin.btnUpdateClick(Sender: TObject);
begin
  if edtNIDN.Text = '' then Exit;

  if TDosenModel.Update(
       edtNIDN.Text,
       edtNama.Text
     ) then
  begin
    ShowMessage('Data dosen berhasil diupdate');
    LoadDosen;
    ClearForm;
  end;
end;

procedure TFrmDosenAdmin.btnDeleteClick(Sender: TObject);
begin
  if edtNIDN.Text = '' then Exit;

  if MessageDlg('Hapus dosen ini?', mtConfirmation,
     [mbYes, mbNo], 0) = mrYes then
  begin
    if TDosenModel.Delete(edtNIDN.Text) then
    begin
      ShowMessage('Data dosen berhasil dihapus');
      LoadDosen;
      ClearForm;
    end;
  end;
end;

{ ================= UI ================= }

procedure TFrmDosenAdmin.btnRefreshClick(Sender: TObject);
begin
  LoadDosen;
end;

procedure TFrmDosenAdmin.btnClearClick(Sender: TObject);
begin
  ClearForm;
end;

procedure TFrmDosenAdmin.btnExitClick(Sender: TObject);
begin
  Close;
end;

procedure TFrmDosenAdmin.sgDosenSelectCell(Sender: TObject;
  ACol, ARow: Integer; var CanSelect: Boolean);
begin
  if ARow = 0 then Exit;

  edtNIDN.Text := sgDosen.Cells[0, ARow];
  edtNama.Text := sgDosen.Cells[1, ARow];
  edtNIDN.Enabled := False;
end;

end.

