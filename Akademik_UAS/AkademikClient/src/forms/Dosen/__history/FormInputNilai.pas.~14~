unit FormInputNilai;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants,
  System.Classes, System.JSON, Vcl.Graphics, Vcl.Controls, Vcl.Forms,
  Vcl.Dialogs, Vcl.ExtCtrls, Vcl.StdCtrls, ApiClient;

type
  TFormNilaiDosen = class(TForm)
    GroupBox1: TGroupBox;
    Label1: TLabel;
    cbMataKuliah: TComboBox;
    Label2: TLabel;
    cbMahasiswa: TComboBox;
    btnSimpan: TButton;
    GroupBox2: TGroupBox;
    edtUts: TEdit;
    edtUAS: TEdit;
    edtTugas: TEdit;
    Label3: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Panel1: TPanel;
    edtGrade: TEdit;
    btnRefresh: TButton;
    procedure FormShow(Sender: TObject);
    procedure cbMataKuliahChange(Sender: TObject);
    procedure edtUtsChange(Sender: TObject);
    procedure edtUASChange(Sender: TObject);
    procedure edtTugasChange(Sender: TObject);
    procedure btnSimpanClick(Sender: TObject);
    procedure btnRefreshClick(Sender: TObject);
  private
    procedure LoadMataKuliah;
    procedure LoadMahasiswa(idMK: string);
    procedure HitungGrade;
  public
  end;

var
  FormNilaiDosen: TFormNilaiDosen;

implementation

{$R *.dfm}

{ ================= INIT ================= }

procedure TFormNilaiDosen.FormShow(Sender: TObject);
begin
  cbMataKuliah.Clear;
  cbMahasiswa.Clear;
  edtUts.Clear;
  edtUAS.Clear;
  edtTugas.Clear;
  edtGrade.Clear;
end;

{ ================= LOAD MATA KULIAH ================= }

procedure TFormNilaiDosen.LoadMataKuliah;
var
  Res: TJSONObject;
  Arr: TJSONArray;
  Obj: TJSONObject;
  i: Integer;
begin
  cbMataKuliah.Items.Clear;
  cbMataKuliah.ItemIndex := -1;

  // pastikan token sudah login tersimpan di Session.Token
  if Session.Token = '' then
  begin
    ShowMessage('Token belum tersedia, silakan login dulu!');
    Exit;
  end;

  // GET mata kuliah dengan header token
  Res := TApiClient.Get('/dosen/mk_saya.php', ['Authorization=Bearer ' + Session.Token]);
  if Res = nil then
  begin
    ShowMessage('Gagal load mata kuliah');
    Exit;
  end;

  // cek status
  if (Res.GetValue('status').Value <> 'true') then
  begin
    ShowMessage('Tidak ada mata kuliah atau token tidak valid');
    Exit;
  end;

  Arr := Res.GetValue<TJSONArray>('data');
  if Arr = nil then Exit;

  for i := 0 to Arr.Count - 1 do
  begin
    Obj := Arr.Items[i] as TJSONObject;
    cbMataKuliah.Items.AddObject(
      Obj.GetValue('nama_mk').AsType<string> + ' (' + Obj.GetValue('kode_mk').AsType<string> + ')',
      TObject(StrToInt(Obj.GetValue('id_matakuliah').AsType<string>))
    );
  end;

  if cbMataKuliah.Items.Count > 0 then
    cbMataKuliah.ItemIndex := 0;

  // Load mahasiswa pertama kali
  if cbMataKuliah.ItemIndex <> -1 then
    LoadMahasiswa(IntToStr(Integer(cbMataKuliah.Items.Objects[cbMataKuliah.ItemIndex])));
end;

{ ================= LOAD MAHASISWA ================= }

procedure TFormNilaiDosen.LoadMahasiswa(idMK: string);
var
  Res: TJSONObject;
  Arr: TJSONArray;
  Obj: TJSONObject;
  i: Integer;
begin
  cbMahasiswa.Items.Clear;
  cbMahasiswa.ItemIndex := -1;

  Res := TApiClient.Get('/dosen/mahasiswa_kelas.php?id_matakuliah=' + idMK, ['Authorization=Bearer ' + Session.Token]);
  if (Res = nil) or (Res.GetValue('status').Value <> 'true') then Exit;

  Arr := Res.GetValue<TJSONArray>('data');
  if Arr = nil then Exit;

  for i := 0 to Arr.Count - 1 do
  begin
    Obj := Arr.Items[i] as TJSONObject;
    cbMahasiswa.Items.AddObject(
      Obj.GetValue('nama').AsType<string> + ' [' + Obj.GetValue('nim').AsType<string> + ']',
      TObject(StrToInt(Obj.GetValue('id_mahasiswa').AsType<string>))
    );
  end;

  if cbMahasiswa.Items.Count > 0 then
    cbMahasiswa.ItemIndex := 0;
end;

{ ================= EVENT COMBOBOX ================= }

procedure TFormNilaiDosen.cbMataKuliahChange(Sender: TObject);
var
  idMK: string;
begin
  if cbMataKuliah.ItemIndex = -1 then Exit;
  idMK := IntToStr(Integer(cbMataKuliah.Items.Objects[cbMataKuliah.ItemIndex]));
  LoadMahasiswa(idMK);
end;

procedure TFormNilaiDosen.edtUtsChange(Sender: TObject);
begin
  HitungGrade;
end;

procedure TFormNilaiDosen.edtUASChange(Sender: TObject);
begin
  HitungGrade;
end;

procedure TFormNilaiDosen.edtTugasChange(Sender: TObject);
begin
  HitungGrade;
end;

{ ================= HITUNG GRADE ================= }

procedure TFormNilaiDosen.HitungGrade;
var
  total: Double;
begin
  total := StrToFloatDef(edtUts.Text,0)*0.3 +
           StrToFloatDef(edtUAS.Text,0)*0.4 +
           StrToFloatDef(edtTugas.Text,0)*0.3;

  if total >= 85 then edtGrade.Text := 'A'
  else if total >= 70 then edtGrade.Text := 'B'
  else if total >= 55 then edtGrade.Text := 'C'
  else if total >= 40 then edtGrade.Text := 'D'
  else edtGrade.Text := 'E';
end;

{ ================= BUTTON ================= }

procedure TFormNilaiDosen.btnRefreshClick(Sender: TObject);
begin
  LoadMataKuliah;
end;

procedure TFormNilaiDosen.btnSimpanClick(Sender: TObject);
var
  idMK, idMhs: string;
  Body: TJSONObject;
  Res: TJSONObject;
begin
  if cbMataKuliah.ItemIndex = -1 then
  begin
    ShowMessage('Pilih mata kuliah dulu');
    Exit;
  end;

  if cbMahasiswa.ItemIndex = -1 then
  begin
    ShowMessage('Pilih mahasiswa dulu');
    Exit;
  end;

  idMK  := IntToStr(Integer(cbMataKuliah.Items.Objects[cbMataKuliah.ItemIndex]));
  idMhs := IntToStr(Integer(cbMahasiswa.Items.Objects[cbMahasiswa.ItemIndex]));

  HitungGrade;

  Body := TJSONObject.Create;
  try
    Body.AddPair('id_matakuliah', idMK);
    Body.AddPair('id_mahasiswa', idMhs);
    Body.AddPair('uts', TJSONNumber.Create(StrToFloatDef(edtUts.Text,0)));
    Body.AddPair('uas', TJSONNumber.Create(StrToFloatDef(edtUAS.Text,0)));
    Body.AddPair('tugas', TJSONNumber.Create(StrToFloatDef(edtTugas.Text,0)));
    Body.AddPair('grade', edtGrade.Text);

    Res := TApiClient.Post('/dosen/input_nilai.php', Body, ['Authorization=Bearer ' + Session.Token]);

    if (Res <> nil) and (Res.GetValue('status').Value = 'true') then
      ShowMessage('Nilai berhasil disimpan')
    else
      ShowMessage('Gagal menyimpan nilai');

  finally
    Body.Free;
  end;
end;

end.

